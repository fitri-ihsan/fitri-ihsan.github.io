<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Tamu Undangan | Fitri & Ihsan</title>
    
    <style>
        /* --- CSS DASAR --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; color: #333;
            overflow-x: hidden;
        }
        .container {
            background: #ffffff; padding: 30px; border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            width: 100%; max-width: 600px; text-align: center;
            box-sizing: border-box; margin-top: 20px;
            position: relative;
        }
        h2 { margin-top: 0; margin-bottom: 5px; color: #222; }
        
        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        
        textarea {
            width: 100%; padding: 12px 15px; font-size: 14px;
            border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-family: inherit;
        }
        textarea#bulkInput { height: 100px; }

        /* --- TOMBOL --- */
        button, .btn-link {
            width: 100%; padding: 12px 20px; font-size: 15px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.2s; color: white; display: inline-block;
            box-sizing: border-box; text-decoration: none;
        }
        .btn-primary { background-color: #007bff; margin-bottom: 15px; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .action-row { display: flex; gap: 10px; margin-top: 10px; }
        
        .btn-success { background-color: #25D366; }
        .btn-success:hover { background-color: #1EAE57; }

        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-copy-sm { background-color: #f1f3f5; color: #333; border: 1px solid #ddd; }
        .btn-copy-sm:hover { background-color: #e9ecef; }

        /* --- LIST HASIL --- */
        #bulkListOutput {
            margin-top: 20px; text-align: left;
            max-height: 600px; overflow-y: auto;
            border: 1px solid #eee; padding: 10px; border-radius: 8px;
            background: #fafafa;
        }
        .result-card {
            background: #fff; border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 15px; margin-bottom: 10px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .result-card.new-item { border-left: 5px solid #007bff; background-color: #f0f7ff; }
        
        .result-info strong { color: #333; font-size: 1.1em; display: block; }
        .result-info small { color: #007bff; word-break: break-all; }

        /* --- STATUS SYNC --- */
        .sync-status {
            font-size: 12px; margin-top: -10px; margin-bottom: 15px;
            display: block; min-height: 1.5em; font-weight: 500;
        }
        .status-idle { color: #999; }
        .status-loading { color: #e67e22; }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        
        /* --- LOADING SPINNER --- */
        .spinner {
            display: inline-block; width: 12px; height: 12px;
            border: 2px solid #ccc;
            border-radius: 50%; border-top-color: #333;
            animation: spin 1s ease-in-out infinite; margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- CUSTOM ALERT --- */
        .aesthetic-alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .aesthetic-alert-overlay.active { opacity: 1; visibility: visible; }
        .aesthetic-alert-box {
            background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 320px;
            text-align: center; transform: scale(0.8); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .aesthetic-alert-overlay.active .aesthetic-alert-box { transform: scale(1); }
        .alert-btn { background: #007bff; color: white; padding: 10px 25px; border-radius: 50px; margin-top: 15px; display: inline-block; width: auto; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Generator Tamu Undangan</h2>
        <label style="color:#666; font-weight:normal; margin-bottom:20px;">NURFITRIANI & SYUKUR AL IHSAN</label>
        
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="form-group">
            <label>Buat Undangan Baru:</label>
            <textarea id="bulkInput" placeholder="Masukkan nama tamu baru disini..."></textarea>
        </div>
        
        <button class="btn-primary" id="bulkGenerateBtn">Generate & Simpan</button>
        
        <span id="syncStatus" class="sync-status status-idle"></span>
        
        <h3 style="text-align:left; font-size:16px; margin-bottom:10px;">Daftar Tamu (Database):</h3>
        <div id="bulkListOutput">
            <div style="text-align:center; padding:20px; color:#999;" id="loadingMsg">
                <div class="spinner"></div> Memuat data dari Google Sheet...
            </div>
        </div>
        
        <div style="margin-top:20px; display:none;"> <textarea id="bulkResultText"></textarea>
        </div>
    </div>

    <div id="custom-alert" class="aesthetic-alert-overlay">
        <div class="aesthetic-alert-box">
            <h3 style="margin:0 0 10px;">Notifikasi</h3>
            <p id="alert-msg" style="color:#666;">Pesan</p>
            <button class="alert-btn" onclick="document.getElementById('custom-alert').classList.remove('active')">OK</button>
        </div>
    </div>

    <script>
        const baseURL = "https://fitri-ihsan.github.io/fi/?";
        
        // ---------------------------------------------------------
        // PASTE URL GOOGLE APPS SCRIPT ANDA DI SINI:
        // ---------------------------------------------------------
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwcUqk5BHC8wLGzKAkZ-bCr0biS020OIWbvm-C8mmmCPOQbJwZFzlOsb9uIR7scgwJj/exec'; 

        const bulkListOutput = document.getElementById("bulkListOutput");
        const syncStatus = document.getElementById("syncStatus");

        document.addEventListener("DOMContentLoaded", function() {
            // Langsung load data saat web dibuka
            loadDataFromSheet();

            const bulkInput = document.getElementById("bulkInput");
            
            // --- FUNGSI GENERATE BARU ---
            document.getElementById("bulkGenerateBtn").addEventListener("click", function() {
                const rawText = bulkInput.value;
                if (!rawText.trim()) { showAlert("Input daftar nama dulu!"); return; }

                const names = rawText.split('\n');
                let count = 0;
                let dataToSync = []; 

                // Proses nama satu per satu
                // Kita balik urutannya agar saat di prepend, urutan input tetap terjaga secara visual
                names.reverse().forEach(name => {
                    const cleanName = name.trim();
                    if (cleanName) {
                        const linkUrl = baseURL + encodeURIComponent(cleanName).replace(/%20/g, '+');
                        
                        // Data object
                        const itemData = { nama: cleanName, link: linkUrl };
                        dataToSync.push(itemData); // Masuk antrian sync

                        // Tambahkan ke UI (Paling Atas)
                        addCardToUI(cleanName, linkUrl, true);
                        count++;
                    }
                });

                if (count > 0) {
                    bulkInput.value = ""; // Kosongkan input
                    // Kembalikan urutan dataToSync ke normal untuk dikirim ke Sheet
                    dataToSync.reverse(); 
                    sendToGoogleSheet(dataToSync);
                } else {
                    showAlert("Tidak ada nama valid.");
                }
            });
        });

        // --- FUNGSI BACA DATA DARI SHEET (GET) ---
        function loadDataFromSheet() {
            if(scriptURL.includes("GANTI_DENGAN")) {
                document.getElementById("loadingMsg").innerText = "URL Script belum diatur.";
                return;
            }

            fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                // Hapus loading message
                bulkListOutput.innerHTML = "";
                
                if(data.length === 0) {
                    bulkListOutput.innerHTML = '<p style="text-align:center; color:#ccc;">Belum ada data tamu.</p>';
                    return;
                }

                // Render setiap item dari database
                data.forEach(item => {
                    addCardToUI(item.nama, item.link, false);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("loadingMsg").innerText = "Gagal memuat data. Cek koneksi/script.";
            });
        }

        // --- FUNGSI TAMPILKAN KARTU (UI) ---
        function addCardToUI(nama, link, isNew) {
            const waMessage = generateWhatsAppMessage(nama, link);
            const safeMsgEncoded = encodeURIComponent(waMessage);
            const waLink = `https://wa.me/?text=${safeMsgEncoded}`;
            
            const newClass = isNew ? "new-item" : "";

            const cardHTML = `
            <div class="result-card ${newClass}">
                <div class="result-info">
                    <strong>${nama}</strong>
                    <small>${link}</small>
                </div>
                <div class="action-row">
                    <a href="${waLink}" target="_blank" class="btn-link btn-success" style="text-align:center; display:flex; align-items:center; justify-content:center; flex:1; font-size:13px;">
                        &#128241; Kirim WA
                    </a>
                    <button class="btn-copy-sm" onclick="copyFullMessage('${safeMsgEncoded}')" style="flex:1;">
                        Salin Pesan
                    </button>
                </div>
            </div>`;

            // Prepend: Tambahkan ke paling atas list
            bulkListOutput.insertAdjacentHTML('afterbegin', cardHTML);
        }

        // --- FUNGSI KIRIM KE GOOGLE SHEET (POST) ---
        function sendToGoogleSheet(data) {
            updateStatus("loading", "⏳ Menyimpan ke database...");

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                updateStatus("success", "✓ Tersimpan!");
                setTimeout(() => { updateStatus("idle", ""); }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                updateStatus("error", "⚠ Gagal menyimpan.");
            });
        }

        function updateStatus(state, message) {
            syncStatus.className = 'sync-status status-' + state;
            syncStatus.innerText = message;
        }

        // --- HELPER FUNCTIONS ---
        function generateWhatsAppMessage(namaAsli, linkLengkap) {
            return `Kepada Yth.\nBapak/Ibu/Saudara(i)\n*${namaAsli}*\n--------------------\n\n*Assalamualaikum Warahmatullahi Wabarakatuh*\n\nTanpa mengurangi rasa hormat perkenankan kami mengundang Bapak/Ibu/Saudara(i) ${namaAsli} untuk menghadiri acara pernikahan kami.\n\n*Nurfitriani & Syukur Al Ihsan*\n\nBerikut Link Undangan kami:\n${linkLengkap}\n\nMerupakan suatu kebahagiaan bagi kami apabila Bapak/Ibu/Saudara(i) ${namaAsli} berkenan untuk hadir dan memberikan doa restu.\nTerima kasih.\n\n*Wassalamualaikum Warahmatullahi Wabarakatuh*`;
        }

        function showAlert(msg) {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('custom-alert').classList.add('active');
        }

        function copyToClipboard(text, successMsg) {
            navigator.clipboard.writeText(text).then(() => showAlert(successMsg))
            .catch(err => { console.error(err); showAlert("Gagal menyalin."); });
        }

        function copyFullMessage(encodedMsg) {
            const fullMessage = decodeURIComponent(encodedMsg);
            copyToClipboard(fullMessage, "Pesan lengkap berhasil disalin!");
        }
    </script>
</body>
</html>
